generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum UserRole {
    SUPER_ADMIN
    ADMIN
    CONSULTANT
    CLIENT
    RESPONDENT
}

enum UserStatus {
    ACTIVE
    INACTIVE
    PENDING
    BLOCKED
}

enum ProjectStatus {
    DRAFT
    IN_PROGRESS
    PENDING_REVIEW
    COMPLETED
    ARCHIVED
}

enum ProjectStage {
    ONBOARDING
    DOCUMENT_COLLECTION
    SURVEY_DISTRIBUTION
    INTERVIEW_PROCESSING
    AI_ANALYSIS
    REPORT_GENERATION
    REVIEW
    DELIVERED
}

enum DocumentType {
    MISSION_VISION_VALUES
    CULTURE_FACTORS
    ORGANIZATIONAL_CHART
    FINANCIAL_DATA
    GOALS_OBJECTIVES
    PRODUCTS_SERVICES
    TEAM_LIST
    POLICY_MANUAL
    OTHER
}

enum DocumentStatus {
    PENDING
    UPLOADED
    VALIDATED
    REJECTED
}

enum SurveyType {
    PARTNERS
    LEADERSHIP
    CLIMATE
    CUSTOM
}

enum SurveyStatus {
    DRAFT
    ACTIVE
    PAUSED
    CLOSED
    ARCHIVED
}

enum QuestionType {
    TEXT
    TEXTAREA
    SINGLE_CHOICE
    MULTIPLE_CHOICE
    SCALE
    NPS
    RATING
    DATE
    FILE
}

enum ResponseStatus {
    PENDING
    IN_PROGRESS
    COMPLETED
    EXPIRED
}

enum InterviewStatus {
    PENDING
    TRANSCRIBED
    PROCESSING
    ANALYZED
    ERROR
}

enum ReportStatus {
    GENERATING
    DRAFT
    REVIEW
    APPROVED
    PUBLISHED
}

enum NotificationType {
    PROJECT_CREATED
    PROJECT_DEADLINE
    PROJECT_COMPLETED
    DOCUMENT_UPLOADED
    DOCUMENT_PENDING
    DOCUMENT_VALIDATED
    SURVEY_CREATED
    SURVEY_RESPONSE
    SURVEY_COMPLETED
    INTERVIEW_SCHEDULED
    INTERVIEW_COMPLETED
    INTERVIEW_ANALYZED
    REPORT_GENERATED
    SYSTEM_UPDATE
    WELCOME
}

enum NotificationStatus {
    PENDING
    SENT
    READ
    FAILED
}

enum AuditAction {
    CREATE
    UPDATE
    DELETE
    LOGIN
    LOGOUT
    EXPORT
    VIEW
}

enum AIContextType {
    PROJECT_OVERVIEW
    INTERVIEWS_ONLY
    SURVEYS_ONLY
    DOCUMENTS_ONLY
    CLIMATE_ANALYSIS
    CULTURE_ANALYSIS
    CROSS_ANALYSIS
    REPORT_GENERATION
}

model Tenant {
    id             String   @id @default(uuid())
    name           String
    slug           String   @unique
    domain         String?  @unique
    logoUrl        String?
    logoPath       String?
    faviconUrl     String?
    faviconPath    String?
    primaryColor   String   @default("#024383")
    secondaryColor String   @default("#1a5a9e")
    accentColor    String   @default("#f59e0b")
    isActive       Boolean  @default(true)
    settings       Json     @default("{}")
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    organizations  Organization[]
    users          User[]
    emailTemplates EmailTemplate[]

    @@map("tenants")
}

model Organization {
    id                  String    @id @default(uuid())
    tenantId            String
    name                String
    tradeName           String?
    cnpj                String?
    industry            String?
    size                String?
    foundedAt           DateTime?
    website             String?
    logoUrl             String?
    logoPath            String?
    addressStreet       String?
    addressNumber       String?
    addressComplement   String?
    addressNeighborhood String?
    addressCity         String?
    addressState        String?
    addressZipCode      String?
    contactEmail        String?
    contactPhone        String?
    contactName         String?
    mission             String?   @db.Text
    vision              String?   @db.Text
    values              String?   @db.Text
    isActive            Boolean   @default(true)
    metadata            Json      @default("{}")
    createdAt           DateTime  @default(now())
    updatedAt           DateTime  @updatedAt

    tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
    users       User[]
    projects    Project[]
    documents   Document[]
    teamMembers TeamMember[]

    @@unique([tenantId, cnpj])
    @@index([tenantId])
    @@map("organizations")
}

model User {
    id                   String     @id @default(uuid())
    tenantId             String
    organizationId       String?
    email                String
    passwordHash         String
    firstName            String
    lastName             String
    avatarUrl            String?
    avatarPath           String?
    phone                String?
    role                 UserRole   @default(RESPONDENT)
    status               UserStatus @default(PENDING)
    emailVerifiedAt      DateTime?
    lastLoginAt          DateTime?
    passwordResetToken   String?
    passwordResetExpires DateTime?
    preferences          Json       @default("{}")
    createdAt            DateTime   @default(now())
    updatedAt            DateTime   @updatedAt

    tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
    organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

    projectsAsConsultant Project[]        @relation("ConsultantProjects")
    projectsAsClient     Project[]        @relation("ClientProjects")
    uploadedDocuments    Document[]       @relation("UploadedBy")
    validatedDocuments   Document[]       @relation("ValidatedBy")
    surveyResponses      SurveyResponse[]
    uploadedInterviews   Interview[]      @relation("UploadedBy")
    createdReports       Report[]
    notifications        Notification[]
    auditLogs            AuditLog[]
    sessions             Session[]

    @@unique([tenantId, email])
    @@index([tenantId])
    @@index([organizationId])
    @@index([email])
    @@map("users")
}

model Session {
    id        String   @id @default(uuid())
    userId    String
    token     String   @unique
    userAgent String?
    ipAddress String?
    expiresAt DateTime
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
    @@map("sessions")
}

model TeamMember {
    id             String    @id @default(uuid())
    organizationId String
    name           String
    email          String
    position       String?
    department     String?
    hireDate       DateTime?
    contractType   String?
    reportsToId    String?
    isActive       Boolean   @default(true)
    metadata       Json      @default("{}")
    createdAt      DateTime  @default(now())
    updatedAt      DateTime  @updatedAt

    organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    reportsTo         TeamMember?        @relation("TeamHierarchy", fields: [reportsToId], references: [id])
    directReports     TeamMember[]       @relation("TeamHierarchy")
    surveyInvitations SurveyInvitation[]

    @@unique([organizationId, email])
    @@index([organizationId])
    @@map("team_members")
}

model Project {
    id             String        @id @default(uuid())
    organizationId String
    consultantId   String
    clientUserId   String?
    code           String        @unique
    name           String
    description    String?
    status         ProjectStatus @default(DRAFT)
    stage          ProjectStage  @default(ONBOARDING)
    startDate      DateTime?
    targetEndDate  DateTime?
    actualEndDate  DateTime?
    progress       Int           @default(0)
    settings       Json          @default("{}")
    createdAt      DateTime      @default(now())
    updatedAt      DateTime      @updatedAt

    organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    consultant   User         @relation("ConsultantProjects", fields: [consultantId], references: [id])
    clientUser   User?        @relation("ClientProjects", fields: [clientUserId], references: [id])

    documents         Document[]
    documentChecklist DocumentChecklist[]
    surveys           Survey[]
    interviews        Interview[]
    reports           Report[]
    aiConversations   AIConversation[]
    activities        ProjectActivity[]

    @@index([organizationId])
    @@index([consultantId])
    @@index([status])
    @@map("projects")
}

model ProjectActivity {
    id          String   @id @default(uuid())
    projectId   String
    userId      String?
    action      String
    description String
    metadata    Json     @default("{}")
    createdAt   DateTime @default(now())

    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@index([projectId])
    @@map("project_activities")
}

model DocumentChecklist {
    id           String         @id @default(uuid())
    projectId    String
    documentType DocumentType
    isRequired   Boolean        @default(true)
    order        Int            @default(0)
    instructions String?
    status       DocumentStatus @default(PENDING)
    createdAt    DateTime       @default(now())
    updatedAt    DateTime       @updatedAt

    project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
    documents Document[]

    @@unique([projectId, documentType])
    @@index([projectId])
    @@map("document_checklists")
}

model Document {
    id               String         @id @default(uuid())
    organizationId   String
    projectId        String
    checklistItemId  String?
    uploadedById     String
    validatedById    String?
    type             DocumentType
    name             String
    description      String?
    fileName         String
    fileUrl          String
    storagePath      String?
    fileSize         Int
    mimeType         String
    status           DocumentStatus @default(PENDING)
    validationNotes  String?
    extractedContent String?
    metadata         Json           @default("{}")
    createdAt        DateTime       @default(now())
    updatedAt        DateTime       @updatedAt

    organization  Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    project       Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
    checklistItem DocumentChecklist? @relation(fields: [checklistItemId], references: [id])
    uploadedBy    User               @relation("UploadedBy", fields: [uploadedById], references: [id])
    validatedBy   User?              @relation("ValidatedBy", fields: [validatedById], references: [id])
    chunks        DocumentChunk[]

    @@index([organizationId])
    @@index([projectId])
    @@index([type])
    @@map("documents")
}

model DocumentChunk {
    id         String   @id @default(uuid())
    documentId String
    content    String
    chunkIndex Int
    tokenCount Int?
    metadata   Json     @default("{}")
    createdAt  DateTime @default(now())

    document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

    @@index([documentId])
    @@map("document_chunks")
}

model OrganizationMetrics {
    id             String   @id @default(uuid())
    organizationId String   @unique
    year           Int
    annualRevenue  Float?
    profitMargin   Float?
    employeeCount  Int?
    turnoverRate   Float?
    averageTenure  Float?
    customMetrics  Json     @default("{}")
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([organizationId])
    @@map("organization_metrics")
}

model SurveyTemplate {
    id          String     @id @default(uuid())
    name        String
    description String?
    type        SurveyType
    isGlobal    Boolean    @default(false)
    isActive    Boolean    @default(true)
    structure   Json
    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @updatedAt

    surveys Survey[]

    @@map("survey_templates")
}

model Survey {
    id                       String       @id @default(uuid())
    projectId                String
    templateId               String?
    type                     SurveyType
    name                     String
    accessCode               String       @unique
    description              String?
    instructions             String?
    status                   SurveyStatus @default(DRAFT)
    isAnonymous              Boolean      @default(true)
    allowMultipleSubmissions Boolean      @default(false)
    startsAt                 DateTime?
    endsAt                   DateTime?
    reminderFrequency        Int?
    settings                 Json         @default("{}")
    createdAt                DateTime     @default(now())
    updatedAt                DateTime     @updatedAt

    project  Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
    template SurveyTemplate? @relation(fields: [templateId], references: [id])

    sections    SurveySection[]
    invitations SurveyInvitation[]
    responses   SurveyResponse[]

    @@index([projectId])
    @@index([status])
    @@index([accessCode])
    @@map("surveys")
}

model SurveySection {
    id          String   @id @default(uuid())
    surveyId    String
    title       String
    description String?
    indicator   String?
    order       Int      @default(0)
    isRequired  Boolean  @default(true)
    conditions  Json     @default("{}")
    metadata    Json     @default("{}")
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    survey    Survey           @relation(fields: [surveyId], references: [id], onDelete: Cascade)
    questions SurveyQuestion[]

    @@index([surveyId])
    @@map("survey_sections")
}

model SurveyQuestion {
    id         String       @id @default(uuid())
    sectionId  String
    type       QuestionType
    text       String
    helpText   String?
    isRequired Boolean      @default(true)
    order      Int          @default(0)
    options    Json?
    validation Json?
    conditions Json         @default("{}")
    metadata   Json         @default("{}")
    createdAt  DateTime     @default(now())
    updatedAt  DateTime     @updatedAt

    section SurveySection  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
    answers SurveyAnswer[]

    @@index([sectionId])
    @@map("survey_questions")
}

model SurveyInvitation {
    id             String         @id @default(uuid())
    surveyId       String
    teamMemberId   String?
    email          String
    name           String?
    token          String         @unique
    status         ResponseStatus @default(PENDING)
    sentAt         DateTime?
    openedAt       DateTime?
    expiresAt      DateTime?
    remindersSent  Int            @default(0)
    lastReminderAt DateTime?
    createdAt      DateTime       @default(now())
    updatedAt      DateTime       @updatedAt

    survey     Survey          @relation(fields: [surveyId], references: [id], onDelete: Cascade)
    teamMember TeamMember?     @relation(fields: [teamMemberId], references: [id])
    response   SurveyResponse?

    @@index([surveyId])
    @@index([token])
    @@index([email])
    @@map("survey_invitations")
}

model SurveyResponse {
    id           String         @id @default(uuid())
    surveyId     String
    invitationId String?        @unique
    respondentId String?
    status       ResponseStatus @default(IN_PROGRESS)
    startedAt    DateTime       @default(now())
    submittedAt  DateTime?
    ipAddress    String?
    userAgent    String?
    duration     Int?
    metadata     Json           @default("{}")
    createdAt    DateTime       @default(now())
    updatedAt    DateTime       @updatedAt

    survey     Survey            @relation(fields: [surveyId], references: [id], onDelete: Cascade)
    invitation SurveyInvitation? @relation(fields: [invitationId], references: [id])
    respondent User?             @relation(fields: [respondentId], references: [id])
    answers    SurveyAnswer[]

    @@index([surveyId])
    @@index([status])
    @@map("survey_responses")
}

model SurveyAnswer {
    id           String   @id @default(uuid())
    responseId   String
    questionId   String
    value        Json
    storagePath  String?
    textValue    String?
    numericValue Float?
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    response SurveyResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
    question SurveyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

    @@unique([responseId, questionId])
    @@index([responseId])
    @@index([questionId])
    @@map("survey_answers")
}

model Interview {
    id                String          @id @default(uuid())
    projectId         String
    uploadedById      String
    title             String
    description       String?
    interviewee       String?
    intervieweeRole   String?
    conductedAt       DateTime?
    duration          Int?
    originalFileName  String?
    transcriptionUrl  String?
    transcriptionPath String?
    rawTranscription  String?
    processedContent  String?
    status            InterviewStatus @default(PENDING)
    aiConversationId  String?
    analysisResult    Json?
    sentimentScore    Float?
    keyThemes         Json?
    anonymizedSummary String?
    metadata          Json            @default("{}")
    createdAt         DateTime        @default(now())
    updatedAt         DateTime        @updatedAt

    project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
    uploadedBy     User            @relation("UploadedBy", fields: [uploadedById], references: [id])
    aiConversation AIConversation? @relation(fields: [aiConversationId], references: [id])

    @@index([projectId])
    @@index([status])
    @@map("interviews")
}

model AIConversation {
    id              String        @id @default(uuid())
    projectId       String
    reportId        String?
    contextType     AIContextType @default(PROJECT_OVERVIEW)
    purpose         String
    model           String        @default("gpt-5.1-mini")
    lastResponseId  String?
    totalTokensUsed Int           @default(0)
    metadata        Json          @default("{}")
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt

    project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
    report     Report?     @relation(fields: [reportId], references: [id])
    interviews Interview[]
    messages   AIMessage[]

    @@index([projectId])
    @@index([contextType])
    @@map("ai_conversations")
}

model AIMessage {
    id             String   @id @default(uuid())
    conversationId String
    role           String
    content        String
    responseId     String?
    tokensUsed     Int      @default(0)
    createdAt      DateTime @default(now())

    conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

    @@index([conversationId])
    @@map("ai_messages")
}

model Report {
    id                  String       @id @default(uuid())
    projectId           String
    createdById         String
    version             Int          @default(1)
    title               String
    status              ReportStatus @default(GENERATING)
    executiveSummary    String?
    culturalAnalysis    String?
    climateIndicators   Json?
    qualitativeAnalysis String?
    actionPlan          String?
    charts              Json?
    customSections      Json?
    generatedContent    Json?
    consultantNotes     String?
    publishedAt         DateTime?
    pdfUrl              String?
    pdfPath             String?
    metadata            Json         @default("{}")
    createdAt           DateTime     @default(now())
    updatedAt           DateTime     @updatedAt

    project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
    createdBy       User             @relation(fields: [createdById], references: [id])
    versions        ReportVersion[]
    aiConversations AIConversation[]

    @@index([projectId])
    @@index([status])
    @@map("reports")
}

model ReportVersion {
    id          String   @id @default(uuid())
    reportId    String
    version     Int
    content     Json
    changedBy   String
    changeNotes String?
    createdAt   DateTime @default(now())

    report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

    @@unique([reportId, version])
    @@index([reportId])
    @@map("report_versions")
}

model EmailTemplate {
    id          String   @id @default(uuid())
    tenantId    String
    slug        String
    name        String
    subject     String
    htmlContent String
    textContent String?
    variables   Json     @default("[]")
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

    @@unique([tenantId, slug])
    @@index([tenantId])
    @@map("email_templates")
}

model Notification {
    id        String             @id @default(uuid())
    userId    String
    type      NotificationType
    title     String
    message   String
    link      String?
    status    NotificationStatus @default(PENDING)
    readAt    DateTime?
    sentAt    DateTime?
    metadata  Json               @default("{}")
    createdAt DateTime           @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([status])
    @@map("notifications")
}

model AuditLog {
    id         String      @id @default(uuid())
    userId     String?
    action     AuditAction
    entityType String
    entityId   String
    oldValues  Json?
    newValues  Json?
    ipAddress  String?
    userAgent  String?
    metadata   Json        @default("{}")
    createdAt  DateTime    @default(now())

    user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([entityType, entityId])
    @@index([createdAt])
    @@map("audit_logs")
}

model SystemSetting {
    id        String   @id @default(uuid())
    key       String   @unique
    value     Json
    group     String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([group])
    @@map("system_settings")
}
